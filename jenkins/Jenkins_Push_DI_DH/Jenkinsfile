timestamps {

  node('my-host') {
  // Start Stages
    stage('Clone') {
      checkout([$class: 'GitSCM',
                  branches: [[name: 'dev']],
                  doGenerateSubmoduleConfigurations: false,
                  extensions: [],
                  submoduleCfg: [],
                  userRemoteConfigs: [[credentialsId: 'github', url: 'https://github.com/arunodhayamsam/node-app.git']]
                ])    
    }  
    stage('Dockebuild and Push') {
        withEnv(["DISABLE_AUTH=new"]) {
         echo "hello ${env.DISABLE_AUTH}"    
          sh 'rm -f ~/.dockercfg ~/.docker/config.json || true'

  // configure registry
         docker.withRegistry('https://831466106657.dkr.ecr.us-east-1.amazonaws.com/node-app', 'ecr:us-east-1:new-ecr') {

    // build image
         def customImage = docker.build("node-app:${env.BUILD_ID}")

    // push image
         def taskdef = customImage.push()
         echo "hello ${env.DISABLE_AUTH}"
         } 
      }
    }
    
    stage('Update ECS Service') {
       withEnv(["DOCKET_IMAGE=831466106657.dkr.ecr.us-east-1.amazonaws.com/node-app:$BUILD_NUMBER"]) {
         echo "hello ${env.DOCKET_IMAGE}"
         sh '''#!/bin/bash
            ls -la
            sed -i -e 's/DOCKER_CONTAINER/${env.DOCKET_IMAGE}/g' task-definition.json
            cat task-definition.json
            '''
    
     }
   
   }
  }  
}

